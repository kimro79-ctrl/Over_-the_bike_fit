name: BikeFit Final Stable Build
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # 2. Java í™˜ê²½ ì„¤ì •
      - name: Java Setup
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Flutter í™˜ê²½ ì„¤ì •
      - name: Flutter Setup
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'

      # 4. Android ë¹Œë“œ ì„¤ì • ë³´ì • ë° Multidex ì˜¤ë¥˜ ìˆ˜ì •
      - name: Android Build Fix & Multidex Configuration
        run: |
          echo "ğŸ§© Android í™˜ê²½ êµ¬ì„± ì‹œì‘"

          # Flutter ìºì‹œ ì •ë¦¬
          flutter clean
          flutter pub get

          # SDK ë²„ì „ ê°•ì œ ì„¤ì •
          sed -i 's/compileSdkVersion [0-9]\+/compileSdkVersion 34/' android/app/build.gradle
          sed -i 's/targetSdkVersion [0-9]\+/targetSdkVersion 34/' android/app/build.gradle
          sed -i 's/minSdkVersion [0-9]\+/minSdkVersion 21/' android/app/build.gradle

          # Multidex í™œì„±í™”
          if ! grep -q "multiDexEnabled true" android/app/build.gradle; then
            sed -i '/defaultConfig {/a \        multiDexEnabled true' android/app/build.gradle
          fi

          # Multidex ë¼ì´ë¸ŒëŸ¬ë¦¬ ì£¼ì…
          if ! grep -q 'androidx.multidex' android/app/build.gradle; then
            sed -i '/dependencies {/a \    implementation "androidx.multidex:multidex:2.0.1"' android/app/build.gradle
          fi

          # Gradle ë¹Œë“œ ë©”ëª¨ë¦¬ í™•ì¥
          echo "org.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError" >> android/gradle.properties

          # Bluetooth ê¶Œí•œ ìë™ ì£¼ì… (ì—†ì„ ì‹œ ì¶”ê°€)
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if ! grep -q "BLUETOOTH_CONNECT" $MANIFEST; then
            sed -i '/<application/i \
    <uses-permission android:name="android.permission.BLUETOOTH_SCAN" />\
    <uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />\
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\
    <uses-permission android:name="android.permission.BLUETOOTH" />\
    <uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />' $MANIFEST
          fi

          echo "âš™ï¸ í™˜ê²½ ì„¤ì • ì™„ë£Œ. ë¹Œë“œ ì‹œì‘"

          # ë¹Œë“œ ì‹¤í–‰ (ë””ë²„ê·¸ APK)
          flutter build apk --debug --no-tree-shake-icons --no-shrink

      # 5. ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: APK íŒŒì¼ ì¶”ì¶œ
        uses: actions/upload-artifact@v4
        with:
          name: IndoorBikeFit_Fixed_V8
          path: build/app/outputs/flutter-apk/app-debug.apk
